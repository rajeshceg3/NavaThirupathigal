<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nava Thirupathigal - A Celestial Journey</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@800&family=Lora:ital,wght@0,400;1,400&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg-light: #fff0f5; /* LavenderBlush */
            --color-bg-panel: #ffffff;
            --color-primary: #967bb6; /* Lavender Purple - WCAG AA compliant with white text */
            --color-primary-light: #ffdab9; /* PeachPuff */
            --color-secondary: #afeeee; /* PaleTurquoise */
            --color-accent: #f0e68c; /* Khaki */
            --color-text-strong: #4a4a4a;
            --color-text-primary: #6c6c6c;
            --color-text-secondary: #9a9a9a;
            --color-border: #f0f0f0;
            --font-display: 'Manrope', sans-serif;
            --font-body: 'Lora', serif;
            --font-tamil: 'Noto Sans Tamil', sans-serif;
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- Base & Typography --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--color-bg-light);
            font-family: var(--font-body);
            color: var(--color-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Animated Gradient Background --- */
        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #f3e6ff, #e6f7ff, #ffe6f0, #fff3e6);
            background-size: 400% 400%;
            animation: gradient-flow 20s ease infinite;
            z-index: -1;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Intro Screen --- */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 1.5s var(--ease-out-quint);
        }
        .intro-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .intro-title {
            font-family: var(--font-display);
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--color-text-strong);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            text-align: center;
            margin: 0 2rem 1.5rem 2.5rem; /* Optical alignment */
            animation: text-reveal 1.5s var(--ease-out-quint) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes text-reveal {
            to { opacity: 1; transform: translateY(0); }
        }
        .intro-subtitle {
            font-family: var(--font-body);
            font-style: italic;
            color: var(--color-text-primary);
            font-size: 1.3rem;
            margin-bottom: 3rem;
            animation: text-reveal 1.5s var(--ease-out-quint) 0.5s forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        .intro-button {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 800;
            color: #fff;
            background: var(--color-primary);
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: var(--shadow-medium);
            transition: transform 0.3s var(--ease-out-quint), box-shadow 0.3s var(--ease-out-quint);
            animation: text-reveal 1.5s var(--ease-out-quint) 1s forwards, pulse-button 2.5s infinite 2s;
            opacity: 0;
            transform: translateY(20px);
        }
        .intro-button:hover {
            transform: scale(1.05) translateY(20px);
            box-shadow: 0 12px 40px rgba(106, 90, 205, 0.4);
            animation-play-state: paused;
        }
        @keyframes pulse-button {
            0% { transform: scale(1) translateY(20px); }
            50% { transform: scale(1.03) translateY(20px); }
            100% { transform: scale(1) translateY(20px); }
        }

        /* --- Main App Layout --- */
        .app-container {
            display: flex;
            height: 100vh;
            background: transparent;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }
        .app-container.visible {
            opacity: 1;
        }

        /* --- Left Navigation Panel --- */
        .nav-panel {
            width: 320px;
            padding: 2rem 0;
            overflow-y: auto;
            flex-shrink: 0;
            background: var(--color-bg-panel);
            border-right: 1px solid var(--color-border);
            z-index: 1000;
        }
        .nav-header {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 2rem;
            padding: 0 1.5rem;
            color: var(--color-text-strong);
        }
        .temple-list { list-style: none; }
        .temple-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-right: 4px solid transparent;
            transition: background-color 0.4s var(--ease-out-quint), border-color 0.4s var(--ease-out-quint);
            position: relative;
        }
        .temple-item:hover { background-color: var(--color-bg-light); }
        .temple-item.active {
            background-color: var(--color-primary-light);
            border-right-color: var(--color-primary);
        }
        .temple-item.active::before {
            content: '';
            position: absolute;
            left: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--color-primary);
            animation: pulse-indicator 1.5s infinite;
        }
        @keyframes pulse-indicator {
            0% { box-shadow: 0 0 0 0 rgba(106, 90, 205, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(106, 90, 205, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 90, 205, 0); }
        }
        .temple-orb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-right: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-display);
            font-weight: 800;
            color: var(--color-text-secondary);
            background: var(--color-bg-light);
            border: 2px solid var(--color-border);
            transition: all 0.4s var(--ease-out-quint);
        }
        .temple-item:hover .temple-orb {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        .temple-item.active .temple-orb {
            background: var(--color-primary);
            color: white;
            border: 2px solid var(--color-primary);
            box-shadow: 0 0 20px rgba(106, 90, 205, 0.5);
        }
        .temple-name-container { display: flex; flex-direction: column; }
        .temple-name-en {
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 1rem;
            color: var(--color-text-strong);
        }
        .temple-name-ta { font-family: var(--font-tamil); font-size: 0.9rem; color: var(--color-text-secondary); }
        
        /* --- Map Area --- */
        .map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; background-color: var(--color-bg-light); }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: rgba(255, 255, 255, 0.8) !important;
            color: var(--color-text-strong) !important;
            border: 1px solid var(--color-border) !important;
            backdrop-filter: blur(5px);
            box-shadow: var(--shadow-light);
        }
        .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover {
            background-color: white !important;
            color: var(--color-primary) !important;
        }
        .leaflet-marker-icon {
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
            transition: transform 0.3s var(--ease-out-quint);
        }
        @keyframes pulse-marker {
            0% { transform: scale(1.1); filter: drop-shadow(0 5px 15px rgba(106, 90, 205, 0.4));}
            50% { transform: scale(1.3); filter: drop-shadow(0 5px 25px rgba(106, 90, 205, 0.6));}
            100% { transform: scale(1.1); filter: drop-shadow(0 5px 15px rgba(106, 90, 205, 0.4));}
        }
        .pulsing-marker { animation: pulse-marker 1.5s infinite; }

        /* --- Info Card --- */
        .info-card {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 380px;
            max-width: 90%;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            transform: translateX(calc(100% + 4rem));
            transition: transform 1s var(--ease-out-quint), opacity 1s var(--ease-out-quint);
            overflow: hidden;
            opacity: 0;
        }
        .info-card.visible {
            transform: translateX(0);
            opacity: 1;
        }
        .info-card.visible { transform: translateX(0); }
        .info-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--color-border);
        }
        .info-card-content { padding: 1.5rem; }
        .info-card-header { margin-bottom: 1rem; }
        .info-card-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            line-height: 1.1;
            font-weight: 800;
            color: var(--color-text-strong);
        }
        .info-card-subtitle-ta { font-family: var(--font-tamil); font-size: 1.2rem; color: var(--color-text-secondary); }
        .info-card-planet-info {
            display: flex;
            align-items: center;
            background: var(--color-bg-light);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--color-border);
        }
        .planet-icon { font-size: 1.5rem; margin-right: 1rem; }
        .planet-text { font-family: var(--font-display); font-size: 1rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--color-primary); }
        .info-card-description { font-family: var(--font-body); font-size: 1rem; line-height: 1.7; color: var(--color-text-primary); }

        .info-card-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.5);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-family: sans-serif;
            line-height: 1;
            transition: background-color 0.3s, transform 0.3s;
        }
        .info-card-close-btn:hover {
            background: white;
            color: var(--color-primary);
            transform: scale(1.1);
        }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .nav-panel { width: 250px; }
            .info-card { width: 320px; }
        }
        
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .nav-panel {
                width: 100%;
                height: auto;
                flex-shrink: 1;
                padding: 1rem;
                box-shadow: 0 10px 40px -15px rgba(0,0,0,0.6);
            }
            .nav-header { font-size: 1.2rem; margin-bottom: 0.5rem; }
            .temple-list { display: flex; overflow-x: auto; padding-bottom: 1rem; -ms-overflow-style: none; scrollbar-width: none; }
            .temple-list::-webkit-scrollbar { display: none; }
            .temple-item { flex-direction: column; align-items: center; padding: 0.5rem; width: 120px; flex-shrink: 0; }
            .temple-orb { margin-right: 0; margin-bottom: 0.5rem; }
            .temple-name-container { text-align: center; }
            .temple-name-en { font-size: 0.8rem; }
            .temple-name-ta { font-size: 0.7rem; }
            
            .info-card {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                border-width: 1px 0 0 0;
            }
            .info-card.visible { transform: translateY(0); }
            .info-card-image { height: 120px; }
            .info-card-content { padding: 1rem; }
            .info-card-title { font-size: 1.5rem; }
            .info-card-close-btn { display: flex; } /* Show close button on mobile */
            .intro-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div class="background-pattern"></div>
    
    <div class="intro-screen" id="intro-screen">
        <h1 class="intro-title">Nava Thirupathigal</h1>
        <p class="intro-subtitle">A Celestial River Journey</p>
        <button class="intro-button" id="intro-button">Begin the Journey</button>
    </div>

    <div class="app-container" id="app-container">
        <nav class="nav-panel">
            <h2 class="nav-header">The Constellation</h2>
            <ul class="temple-list" id="temple-list"></ul>
        </nav>
        <main class="map-container">
            <div id="map"></div>
            <div class="info-card" id="info-card">
                <button class="info-card-close-btn" id="info-card-close-btn">Ã—</button>
                <img src="" alt="" class="info-card-image" id="info-card-image">
                <div class="info-card-content">
                    <div class="info-card-header">
                        <h3 class="info-card-title" id="info-card-title"></h3>
                        <p class="info-card-subtitle-ta" id="info-card-subtitle-ta"></p>
                    </div>
                    <div class="info-card-planet-info">
                        <span class="planet-icon" id="planet-icon"></span>
                        <span class="planet-text" id="planet-text"></span>
                    </div>
                    <p class="info-card-description" id="info-card-description"></p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Data ---
            const templeData = [
                { id: 0, name: 'Srivaikuntam', tamilName: 'à®¸à¯à®°à¯€à®µà¯ˆà®•à¯à®£à¯à®Ÿà®®à¯', planet: 'Sun', planetIcon: 'â˜€ï¸', coords: [8.6292, 77.9042], image: 'https://images.unsplash.com/photo-1600238323590-42f42be29772?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTV8fFNyaXZhaWt1bnRhbSUyMHRlbXBsZXxlbnwwfHwwfHx8MA%3D%3D', description: 'The first temple in the pilgrimage, dedicated to Lord Vishnu as Vaikunthanathan. It is associated with Surya (the Sun) and is believed to grant devotees a life free from obstacles.' },
                { id: 1, name: 'Thiruvaragunamangai', tamilName: 'à®¤à®¿à®°à¯à®µà®°à®•à¯à®£à®®à®™à¯à®•à¯ˆ', planet: 'Moon', planetIcon: 'ðŸŒ™', coords: [8.6419, 77.9211], image: 'https://images.unsplash.com/photo-1565195161077-f5c5f61f9ea2?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8aGluZHUlMjB0ZW1wbGV8ZW58MHx8MHx8fDA%3D', description: 'Known as Natham, this temple is dedicated to Lord Vijayasana Perumal. It is linked to Chandra (the Moon), and worship here is said to bestow mental peace and clarity.' },
                { id: 2, name: 'Thirupuliyangudi', tamilName: 'à®¤à®¿à®°à¯à®ªà¯à®ªà¯à®³à®¿à®¯à®™à¯à®•à¯à®Ÿà®¿', planet: 'Mars', planetIcon: 'ðŸª', coords: [8.6483, 77.9258], image: 'https://images.unsplash.com/photo-1524443169398-9aa1ceab67d5?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8aGluZHUlMjB0ZW1wbGV8ZW58MHx8MHx8fDA%3D', description: 'Worshipped as Kasinivendan Perumal, this temple is associated with Budhan (Mercury). Devotees pray here for wisdom, knowledge, and success in education and communication.' },
                { id: 3, name: 'Rettai Tirupati (North)', tamilName: 'à®‡à®°à®Ÿà¯à®Ÿà¯ˆ à®¤à®¿à®°à¯à®ªà¯à®ªà®¤à®¿ (à®µà®Ÿà®•à¯à®•à¯)', planet: 'Rahu', planetIcon: 'â˜„ï¸', coords: [8.6651, 77.9599], image: 'https://images.unsplash.com/photo-1566300141301-ab0577dcba1c?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8aGluZHUlMjB0ZW1wbGV8ZW58MHx8MHx8fDA%3D', description: 'One of the twin temples, dedicated to Aravindalochanar. It is associated with Rahu, and prayers here are believed to alleviate the malefic effects of this celestial body.' },
                { id: 4, name: 'Rettai Tirupati (South)', tamilName: 'à®‡à®°à®Ÿà¯à®Ÿà¯ˆ à®¤à®¿à®°à¯à®ªà¯à®ªà®¤à®¿ (à®¤à¯†à®±à¯à®•à¯)', planet: 'Ketu', planetIcon: 'ðŸ’«', coords: [8.6644, 77.9602], image: 'https://images.unsplash.com/photo-1573352763925-82bd5dfc31d1?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8aGluZHUlMjB0ZW1wbGV8ZW58MHx8MHx8fDA%3D', description: 'The other twin temple, dedicated to Devapiran. It is linked to Ketu, and worship here is said to grant spiritual enlightenment and freedom from worldly bonds.' },
                { id: 5, name: 'Thirukkulanthai', tamilName: 'à®¤à®¿à®°à¯à®•à¯à®•à¯à®³à®¨à¯à®¤à¯ˆ', planet: 'Saturn', planetIcon: 'ðŸª', coords: [8.6536, 77.9458], image: 'https://images.unsplash.com/photo-1644130919109-b3376a0368e2?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OHx8aGluZHUlMjB0ZW1wbGV8ZW58MHx8MHx8fDA%3D', description: 'Known as Perunkulam, the deity here is Srinivasa Perumal. This temple is associated with Shani (Saturn), and worship is believed to mitigate hardships and grant longevity.' },
                { id: 6, name: 'Thirukolur', tamilName: 'à®¤à®¿à®°à¯à®•à¯à®•à¯‹à®³à¯‚à®°à¯', planet: 'Mars', planetIcon: 'â˜„ï¸', coords: [8.6834, 78.0053], image: 'https://images.unsplash.com/photo-1610901706842-5fb2c3e88dd4?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTB8fGhpbmR1JTIwdGVtcGxlfGVufDB8fDB8fHww', description: 'Home to Vaithamanidhi Perumal, this temple is associated with Angaraka (Mars). Devotees pray here to recover lost wealth and to overcome debts and financial troubles.' },
                { id: 7, name: 'Thiruperai', tamilName: 'à®¤à®¿à®°à¯à®ªà¯à®ªà¯‡à®°à¯ˆ', planet: 'Venus', planetIcon: 'âœ¨', coords: [8.6575, 77.9786], image: 'https://images.unsplash.com/photo-1632962237468-0705d7e7b534?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTF8fGhpbmR1JTIwdGVtcGxlfGVufDB8fDB8fHww', description: 'Here, Lord Vishnu is Makara Nedunkuzhaikathar. The temple is associated with Shukra (Venus) and is a place to pray for happy relationships, luxury, and artistic talents.' },
                { id: 8, name: 'Alwarthirunagari', tamilName: 'à®†à®´à¯à®µà®¾à®°à¯à®¤à®¿à®°à¯à®¨à®•à®°à®¿', planet: 'Jupiter', planetIcon: 'â˜„ï¸', coords: [8.6014, 77.8767], image: 'https://images.unsplash.com/photo-1642516864189-97152c4cffb2?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MTJ8fGhpbmR1JTIwdGVtcGxlfGVufDB8fDB8fHww', description: 'The final temple, dedicated to Adinathan. It is the birthplace of the saint Nammalvar and is linked to Guru (Jupiter), the bestower of wisdom, fortune, and divine grace.' }
            ];
            
            // --- DOM Elements ---
            const introScreen = document.getElementById('intro-screen');
            const introButton = document.getElementById('intro-button');
            const appContainer = document.getElementById('app-container');
            const templeList = document.getElementById('temple-list');
            const infoCard = document.getElementById('info-card');
            const infoCardCloseBtn = document.getElementById('info-card-close-btn');
            // ... (rest of info card elements are queried inside render function for tidiness)
            
            // --- App State & Core Variables ---
            let map;
            let markers = [];
            let templeNavItems = [];
            let activeTempleId = null; // SINGLE SOURCE OF TRUTH

            // --- Core Functions ---
            
            // Centralized State Mutator: The only way to change the active temple
            function setActiveTemple(id) {
                if (id === activeTempleId) return; // Do nothing if already active
                activeTempleId = id;
                render();
            }

            // Declarative Render Function: Updates the entire UI based on the current state
            function render() {
                // Update Nav List
                templeNavItems.forEach((item, index) => {
                    item.classList.toggle('active', index === activeTempleId);
                });

                // Update Markers
                markers.forEach((marker, index) => {
                    marker.getElement()?.classList.toggle('pulsing-marker', index === activeTempleId);
                });

                if (activeTempleId !== null) {
                    const temple = templeData[activeTempleId];
                    
                    // Update and show info card
                    document.getElementById('info-card-image').src = temple.image;
                    document.getElementById('info-card-image').alt = temple.name;
                    document.getElementById('info-card-title').textContent = temple.name;
                    document.getElementById('info-card-subtitle-ta').textContent = temple.tamilName;
                    document.getElementById('planet-icon').textContent = temple.planetIcon;
                    document.getElementById('planet-text').textContent = temple.planet;
                    document.getElementById('info-card-description').textContent = temple.description;
                    infoCard.classList.add('visible');
                    
                    // Fly map to location
                    map.flyTo(temple.coords, 15, { animate: true, duration: 1.5 });

                } else {
                    // Hide info card if no temple is selected
                    infoCard.classList.remove('visible');
                }
            }

            function initMap() {
                map = L.map('map', { center: [8.64, 77.94], zoom: 12, zoomControl: false });
                L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.{ext}', {
                    attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',
                    subdomains: 'abcd',
                    minZoom: 1,
                    maxZoom: 16,
                    ext: 'jpg'
                }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
            }

            // Optimized population function
            function populateNavAndMarkers() {
                const fragment = document.createDocumentFragment(); // Use fragment for performance
                const customIcon = L.icon({
                    iconUrl: `data:image/svg+xml;base64,${btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 48">
                            <defs>
                                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feDropShadow dx="0" dy="4" stdDeviation="4" flood-color="rgba(0,0,0,0.15)"/>
                                </filter>
                            </defs>
                            <path d="M16,0 C7.163,0 0,7.163 0,16 C0,28 16,48 16,48 C16,48 32,28 32,16 C32,7.163 24.837,0 16,0 Z" fill="#ffffff" filter="url(#shadow)"/>
                            <circle cx="16" cy="16" r="8" fill="${getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim()}"/>
                        </svg>
                    `)}`,
                    iconSize: [32, 48],
                    iconAnchor: [16, 48],
                    popupAnchor: [0, -48]
                });

                templeData.forEach(temple => {
                    // Create Nav Item
                    const li = document.createElement('li');
                    li.className = 'temple-item';
                    li.innerHTML = `<div class="temple-orb">${temple.id + 1}</div><div class="temple-name-container"><span class="temple-name-en">${temple.name}</span><span class="temple-name-ta">${temple.tamilName}</span></div>`;
                    li.addEventListener('click', () => setActiveTemple(temple.id));
                    fragment.appendChild(li);

                    // Create Map Marker with Bidirectional Link
                    const marker = L.marker(temple.coords, { icon: customIcon }).addTo(map);
                    marker.on('click', () => setActiveTemple(temple.id)); // <-- BUG FIX: Bidirectional interaction
                    markers.push(marker);
                });

                templeList.appendChild(fragment); // Single DOM insertion
                templeNavItems = Array.from(templeList.children); // Cache DOM nodes
            }

            // --- Event Listeners & Initialization ---
            introButton.addEventListener('click', () => {
                introScreen.classList.add('hidden');
                appContainer.classList.add('visible');
                map.invalidateSize(); // Ensure map renders correctly after being unhidden
                setActiveTemple(0); // BUG FIX: Set initial state immediately for seamless transition
            });
            
            infoCardCloseBtn.addEventListener('click', () => {
                setActiveTemple(null); // BUG FIX: Allows closing the info card
            });

            // --- Initializer ---
            initMap();
            populateNavAndMarkers();
        });
    </script>
</body>
</html>
